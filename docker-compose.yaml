---
version: '3.2'

services:
  ghost:
    image: ghost:latest
    volumes:
      - ./ghost/config.production.json:/var/lib/ghost/config.production.json
      - ghost_content:/var/lib/ghost/content
    environment:
      - "database__client:mariadb"
      - "database__connection__host:mariadb"
      - "database__connection__user:ghostly"
      - "database__connection__password:ahnonotanotheroneofthosereallybastardlongpasswords..?"
      - "database__connection__database:ghost"
    networks:
      - abitmoredepth
    deploy:
      mode: replicated
      replicas: 1
      restart_policy:
        condition: any
      labels:
        - "traefik.backend=ghost"
        - "traefik.enable=true"
        - "traefik.frontend.entryPoints=http,https"
        - "traefik.frontend.redirect.entryPoint=https"
        - "traefik.frontend.rule=Host:www.abitmoredepth.com,abitmoredepth.com"
        - "traefik.port=2368"

  mariadb:
    image: mariadb:5
    volumes:
      - maria_data:/var/lib/mysql
    environment:
      - "MYSQL_ROOT_PASSWORD=Holyfeckthisisoneofthosereallydamnablylongrootpasswords!!"
      - "MYSQL_DATABASE=ghost"
      - "MYSQL_USER=ghostly"
      - "MYSQL_PASSWORD=ahnonotanotheroneofthosereallybastardlongpasswords..?"
    networks:
      - abitmoredepth
    deploy:
      mode: replicated
      replicas: 1
      restart_policy:
        condition: any

  portainer:
    image: portainer/portainer
    volumes:
      - type: bind
        source: /var/run/docker.sock
        target: /var/run/docker.sock
      - type: volume
        source: portainer-data
        target: /data
    networks:
      - abitmoredepth
    deploy:
      mode: replicated
      replicas: 1
      restart_policy:
        condition: any
      labels:
        - "traefik.backend=portainer"
        - "traefik.enable=true"
        - "traefik.frontend.entryPoints=http,https"
        - "traefik.frontend.redirect.entryPoint=https"
        - "traefik.frontend.rule=Host:manage.abitmoredepth.com"
        - "traefik.port=9000"

  traefik:
    image: traefik
    build:
      context: traefik/
      dockerfile: Dockerfile
    ports:
      - "443:443"
      - "8080:8080"
      - "80:80"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./traefik/traefik.toml:/traefik.toml
      - ./traefik/certs:/etc/traefik/acme/
    networks:
      - abitmoredepth
    deploy:
      mode: replicated
      replicas: 1
      restart_policy:
        condition: any
      labels:
        - "traefik.backend=traefik"
        - "traefik.enable=true"
        - "traefik.frontend.entryPoints=http,https"
        - "traefik.frontend.redirect.entryPoint=https"
        - "traefik.frontend.rule=Host:traefik.abitmoredepth.com"
        - "traefik.port=8080"

volumes:
  ghost_content:

  ghost_source:

  maria_data:

  portainer-data:

networks:
  abitmoredepth:
    driver: overlay
    attachable: true
